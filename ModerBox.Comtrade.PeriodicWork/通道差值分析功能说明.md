# 通道差值分析功能说明

## 概述

通道差值分析功能用于自动扫描Comtrade波形文件，查找特定的电流通道并计算它们之间的差值，然后将结果导出到Excel文件中。

## 功能特点

- **自动文件扫描**：递归搜索指定文件夹下的所有.cfg波形文件
- **智能通道匹配**：自动查找包含IDEL1、IDEL2、IDEE1、IDEE2四个通道的文件
- **差值计算**：计算IDEL1-IDEE1和IDEL2-IDEE2两个差值
- **高级计算**：计算(IDEL1-IDEE1)-(IDEL2-IDEE2)差值的差值和差值百分比
- **Excel导出**：将所有结果汇总到Excel表格中，每个数据点占一行

## 使用方法

### 1. 通过UI界面使用

1. 在ModerBox主界面中点击"通道差值分析"菜单项
2. 选择要扫描的源文件夹（包含Comtrade波形文件）
3. 选择Excel输出文件的保存位置
4. 点击"开始分析"按钮
5. 等待处理完成，查看生成的Excel文件

### 2. 通过代码调用

```csharp
var periodicWork = new PeriodicWork();

// 调用专用方法
await periodicWork.DoChannelDifferenceAnalysis(
    folderPath: @"C:\波形文件目录",
    exportPath: @"C:\输出\通道差值分析结果.xlsx"
);

// 或者使用服务
var service = new ChannelDifferenceAnalysisService();
var senderProtocol = new ChannelDifferenceAnalysisSenderProtocol {
    FolderPath = @"C:\波形文件目录"
};
var result = await service.ProcessingAsync(senderProtocol);
```

## 输入要求

- **文件格式**：Comtrade格式的波形文件（.cfg和.dat文件）
- **必需通道**：文件必须包含以下四个通道：
  - IDEL1：第一路差动电流
  - IDEL2：第二路差动电流  
  - IDEE1：第一路制动电流
  - IDEE2：第二路制动电流

## 输出格式

生成的Excel文件包含以下列：

| 列名 | 说明 |
|------|------|
| 文件名 | 源波形文件的名称（不含扩展名） |
| 点序号 | 数据点的序号（从1开始） |
| IDEL1 | 第一路差动电流值 |
| IDEL2 | 第二路差动电流值 |
| IDEE1 | 第一路制动电流值 |
| IDEE2 | 第二路制动电流值 |
| IDEL1-IDEE1 | 第一组差值 |
| IDEL2-IDEE2 | 第二组差值 |
| (IDEL1-IDEE1)-(IDEL2-IDEE2) | 差值的差值 |
| 差值百分比(%) | ((IDEL1-IDEE1)-(IDEL2-IDEE2))/(IDEL1-IDEE1)×100% |

## 技术特点

- **并行处理**：多个文件同时处理，提高效率
- **异常处理**：自动跳过损坏或不符合要求的文件
- **进度跟踪**：实时显示处理进度和状态
- **内存优化**：逐文件处理，避免内存占用过大

## 注意事项

1. **文件完整性**：确保.cfg和.dat文件成对存在
2. **通道命名**：通道名称必须严格匹配（区分大小写）
3. **数据一致性**：四个通道的数据长度必须一致
4. **磁盘空间**：确保有足够空间保存Excel输出文件
5. **处理时间**：大量文件处理可能需要较长时间
6. **百分比计算**：当IDEL1-IDEE1为0时，差值百分比自动设为0以避免除零错误

## 错误处理

- 如果文件夹不存在，将返回空结果
- 如果文件缺少必需通道，将跳过该文件并记录日志
- 如果文件读取失败，将跳过该文件并继续处理其他文件
- 所有错误信息都会输出到控制台日志中

## 示例配置

如果使用配置文件方式，可以在DataSpec中配置：

```json
{
  "ChannelDifferenceAnalysisData": [
    {
      "Name": "通道差值分析",
      "DisplayName": "通道差值分析结果"
    }
  ]
}
``` 