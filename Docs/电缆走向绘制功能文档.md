# 电缆走向自动化绘制

## 功能介绍

**电缆走向绘制** 模块提供自动化的电缆路由规划和绘制功能。根据用户提供的配置文件（JSON 格式），程序能够：

1. **智能路径规划**：利用 Dijkstra 算法计算观测点间的最短路径
2. **自动连线绘制**：
   - 直线连接：观测点 ↔ 观测点、同 pair 的穿管点
   - L 型连接：start/end/pass → observation
3. **碰撞检测**：在终点附近自动放置业务统计表格，避免与已有元素重叠
4. **高质量输出**：基于 SkiaSharp 生成 PNG/JPG 格式的矢量级图像

## 快速开始

### 1. 创建示例配置

在应用中打开"电缆走向绘制"标签页，点击 **"创建示例"** 按钮，即可生成示例配置文件。

### 2. 编辑配置文件

编辑生成的 JSON 配置文件，定义电缆网络中的所有点位和业务统计数据。

### 3. 执行绘制

- **配置文件**：必选，需先创建或选择配置文件
- **底图路径**：可选，若指定则覆盖配置文件中的设置
- **输出路径**：可选，若指定则覆盖配置文件中的设置

点击 **"开始绘制"** 开始处理。程序会实时输出执行日志，最后自动打开输出目录。

## 配置文件格式

### 完整示例

```json
{
  "baseImagePath": "base.jpg",
  "outputPath": "result.png",
  "points": [
    {
      "id": "S1",
      "type": "Start",
      "x": 100,
      "y": 200
    },
    {
      "id": "O1",
      "type": "Observation",
      "x": 200,
      "y": 200
    },
    {
      "id": "O2",
      "type": "Observation",
      "x": 200,
      "y": 400
    },
    {
      "id": "O3",
      "type": "Observation",
      "x": 400,
      "y": 200
    },
    {
      "id": "O4",
      "type": "Observation",
      "x": 400,
      "y": 400
    },
    {
      "id": "O5",
      "type": "Observation",
      "x": 600,
      "y": 300
    },
    {
      "id": "O6",
      "type": "Observation",
      "x": 600,
      "y": 500
    },
    {
      "id": "P1A",
      "type": "Pass",
      "x": 300,
      "y": 300,
      "pair": "P1"
    },
    {
      "id": "P1B",
      "type": "Pass",
      "x": 500,
      "y": 300,
      "pair": "P1"
    },
    {
      "id": "E1",
      "type": "End",
      "x": 700,
      "y": 400
    }
  ],
  "endTable": {
    "title": "终点下级业务",
    "rows": [
      {
        "name": "摄像头",
        "count": 6
      },
      {
        "name": "AP",
        "count": 4
      },
      {
        "name": "门禁",
        "count": 2
      },
      {
        "name": "广播",
        "count": 1
      }
    ]
  }
}
```

### 字段说明

#### 顶级属性

| 字段 | 类型 | 必需 | 说明 |
|------|------|------|------|
| `baseImagePath` | string | 是 | 底图文件路径（JPG、PNG 等） |
| `outputPath` | string | 否 | 输出文件路径，默认为 `result.png` |
| `points` | Array | 是 | 点位数组 |
| `endTable` | Object | 否 | 终点业务统计表格 |

#### points 数组元素（RoutePoint）

| 字段 | 类型 | 必需 | 说明 |
|------|------|------|------|
| `id` | string | 是 | 点位的唯一标识符（例如 "S1"、"O1"） |
| `type` | string | 是 | 点位类型，可选值：`Start`、`Observation`、`Pass`、`End` |
| `x` | integer | 是 | X 坐标（像素） |
| `y` | integer | 是 | Y 坐标（像素） |
| `pair` | string | 否 | 穿管点配对标识，仅当 `type` 为 `Pass` 时设置 |

#### 点位类型说明

| 类型 | 说明 | 绘制颜色 |
|------|------|----------|
| `Start` | 起点（1 个） | 绿色 |
| `Observation` | 观测点/中继点（多个） | 白色 |
| `Pass` | 穿管点（成对出现） | 黄色 |
| `End` | 终点（1 个） | 蓝色 |

#### endTable 对象

用于在终点附近绘制业务统计表格。

| 字段 | 类型 | 必需 | 说明 |
|------|------|------|------|
| `title` | string | 否 | 表格标题，默认为 "终点下级业务" |
| `rows` | Array | 是 | 表格行数组 |

#### endTable.rows 数组元素

| 字段 | 类型 | 必需 | 说明 |
|------|------|------|------|
| `name` | string | 是 | 业务名称（例如 "摄像头"） |
| `count` | integer | 是 | 数量 |

## 路径规划算法

### 总体流程

1. **start 到最近的 observation**
2. **observation 图最短路**（使用 Dijkstra 算法）→ 某个 observation
3. **observation 到最近的 pass**
4. **pass A 到 pass B**（同 pair）
5. **pass 到最近的 observation**（朝向 end）
6. **observation 图最短路** → 离 end 最近的 observation
7. **observation 到 end**

### 连接规则

- **observation ↔ observation**：直线连接
- **同 pair 的 pass 点**：直线连接
- **start/end/pass → observation**：L 型正交连接

## 正交修正机制

当需要生成 L 型连接时，程序会在 observation 集合中搜索满足以下条件的中间拐点：

- `(x == A.x and y == B.y)`
- 或 `(y == A.y and x == B.x)`

如果存在多个，选择距离最短的；如果不存在，使用默认 L 型路径（先水平后垂直）。

## 常见问题

### Q: 配置文件中相对路径如何处理？

A: 相对路径会以配置文件所在目录为基准进行解析。在 GUI 中指定的路径优先级更高，会覆盖配置文件中的设置。

### Q: 输出图像尺寸如何确定？

A: 输出图像尺寸由底图决定。若底图不存在，程序会创建 900×700 的空白画布。

### Q: 表格位置冲突如何解决？

A: 程序会按以下优先级尝试放置表格：右上 → 右下 → 左上 → 左下 → 上 → 下

### Q: 支持哪些输出格式？

A: 基于文件扩展名自动识别，支持 PNG、JPG/JPEG、BMP、WebP。推荐使用 PNG 获得最佳质量。

## 示例工作流

### 场景：规划局域网布线

1. **获取底图**：拍照或扫描建筑平面图
2. **标注点位**：在平面图上标记各个布线点
3. **手工测量**：用标尺或激光测距工具获得坐标
4. **创建配置**：在程序中点击"创建示例"
5. **填写数据**：编辑配置文件，输入所有点位坐标
6. **运行绘制**：启动绘制过程
7. **验证结果**：检查生成的走向图是否符合实际需求

## 技术细节

### 图算法

- **图类型**：观测点间构成无向完全图
- **最短路径**：Dijkstra 算法，时间复杂度 O((V+E)logV)
- **距离度量**：欧氏距离

### 碰撞检测

使用轴对齐边界框（AABB）进行快速碰撞检测，支持位置优先级排序。

### 图像渲染

基于 **SkiaSharp** 库，提供：
- 抗锯齿线条绘制
- 文字描边效果
- 高质量导出

## 参考资源

- [SkiaSharp 文档](https://docs.microsoft.com/en-us/xamarin/xamarin-forms/user-interface/graphics/skiasharp/)
- [Dijkstra 算法解析](https://en.wikipedia.org/wiki/Dijkstra%27s_algorithm)
- [JSON Schema 规范](https://json-schema.org/)
