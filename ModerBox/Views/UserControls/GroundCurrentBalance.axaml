<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:ModerBox.ViewModels"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
             x:Class="ModerBox.Views.UserControls.GroundCurrentBalance"
             x:DataType="vm:GroundCurrentBalanceViewModel">
  
  <Design.DataContext>
    <vm:GroundCurrentBalanceViewModel/>
  </Design.DataContext>

  <ScrollViewer>
    <Grid Margin="20" RowDefinitions="Auto,Auto,Auto,Auto,*,Auto">
      
      <!-- 标题 -->
      <TextBlock Grid.Row="0" 
                 Text="接地极电流平衡分析" 
                 FontSize="24" 
                 FontWeight="Bold" 
                 Margin="0,0,0,20"/>

      <!-- 配置区域 -->
      <Border Grid.Row="1" 
              Background="LightGray" 
              CornerRadius="8" 
              Padding="15" 
              Margin="0,0,0,15">
        <StackPanel>
          <TextBlock Text="分析配置" FontWeight="Bold" FontSize="16" Margin="0,0,0,10"/>
          
          <!-- 文件夹选择 -->
          <Grid ColumnDefinitions="Auto,*,Auto" Margin="0,5">
            <TextBlock Grid.Column="0" Text="文件夹路径:" VerticalAlignment="Center" Width="100"/>
            <TextBox Grid.Column="1" 
                     Text="{Binding SelectedFolderPath}" 
                     IsReadOnly="True" 
                     Margin="10,0"/>
            <Button Grid.Column="2" 
                    Content="选择文件夹" 
                    Command="{Binding SelectFolderCommand}"
                    Margin="10,0,0,0"/>
          </Grid>

          <!-- 平衡阈值设置 -->
          <Grid ColumnDefinitions="Auto,Auto,Auto" Margin="0,10,0,5">
            <TextBlock Grid.Column="0" Text="平衡阈值:" VerticalAlignment="Center" Width="100"/>
            <NumericUpDown Grid.Column="1" 
                           Value="{Binding BalanceThreshold}" 
                           Minimum="0.1" 
                           Maximum="50" 
                           Increment="0.1"
                           FormatString="F1"
                           Width="120"
                           Margin="10,0"/>
            <TextBlock Grid.Column="2" Text="%" VerticalAlignment="Center" Margin="5,0"/>
          </Grid>
        </StackPanel>
      </Border>

      <!-- 操作按钮 -->
      <StackPanel Grid.Row="2" 
                  Orientation="Horizontal" 
                  HorizontalAlignment="Center" 
                  Margin="0,0,0,15">
        <Button Content="开始分析" 
                Command="{Binding StartAnalysisCommand}"
                IsEnabled="{Binding !IsAnalyzing}"
                Padding="20,8" 
                Margin="0,0,10,0"/>
        <Button Content="导出报告" 
                Command="{Binding ExportResultsCommand}"
                Padding="20,8" 
                Margin="10,0,0,0"/>
      </StackPanel>

      <!-- 状态信息 -->
      <Grid Grid.Row="3" 
            ColumnDefinitions="*,Auto,Auto,Auto,Auto" 
            Margin="0,0,0,15">
        <TextBlock Grid.Column="0" 
                   Text="{Binding StatusMessage}" 
                   VerticalAlignment="Center"/>
        
        <!-- 统计信息 -->
        <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="15">
          <Border Background="LightGreen" CornerRadius="4" Padding="8,4">
            <StackPanel Orientation="Horizontal" Spacing="5">
              <TextBlock Text="平衡:" FontWeight="Bold"/>
              <TextBlock Text="{Binding BalancedCount}"/>
            </StackPanel>
          </Border>
          
          <Border Background="LightCoral" CornerRadius="4" Padding="8,4">
            <StackPanel Orientation="Horizontal" Spacing="5">
              <TextBlock Text="不平衡:" FontWeight="Bold"/>
              <TextBlock Text="{Binding UnbalancedCount}"/>
            </StackPanel>
          </Border>
          
          <Border Background="LightGray" CornerRadius="4" Padding="8,4">
            <StackPanel Orientation="Horizontal" Spacing="5">
              <TextBlock Text="未知:" FontWeight="Bold"/>
              <TextBlock Text="{Binding UnknownCount}"/>
            </StackPanel>
          </Border>
        </StackPanel>

        <!-- 进度指示器 -->
        <ProgressBar Grid.Column="4" 
                     IsIndeterminate="{Binding IsAnalyzing}"
                     IsVisible="{Binding IsAnalyzing}"
                     Width="100" 
                     Height="20"/>
      </Grid>

      <!-- 结果数据网格 -->
      <DataGrid Grid.Row="4" 
                ItemsSource="{Binding Results}"
                AutoGenerateColumns="False"
                CanUserResizeColumns="True"
                CanUserSortColumns="True"
                GridLinesVisibility="All"
                BorderThickness="1"
                BorderBrush="Gray">
        
        <DataGrid.Columns>
          <DataGridTextColumn Header="文件名" Binding="{Binding FileName}" Width="150"/>
          <DataGridTextColumn Header="点序号" Binding="{Binding PointIndex}" Width="80"/>
                          <DataGridTextColumn Header="IDEL1" Binding="{Binding IDEL1, StringFormat=F3}" Width="100"/>
                <DataGridTextColumn Header="IDEL2" Binding="{Binding IDEL2, StringFormat=F3}" Width="100"/>
                <DataGridTextColumn Header="IDEE1" Binding="{Binding IDEE1, StringFormat=F3}" Width="100"/>
                <DataGridTextColumn Header="IDEE2" Binding="{Binding IDEE2, StringFormat=F3}" Width="100"/>
          <DataGridTextColumn Header="差值1" Binding="{Binding Difference1, StringFormat=F3}" Width="80"/>
          <DataGridTextColumn Header="差值2" Binding="{Binding Difference2, StringFormat=F3}" Width="80"/>
          <DataGridTextColumn Header="差值的差值" Binding="{Binding DifferenceBetweenDifferences, StringFormat=F3}" Width="100"/>
          <DataGridTextColumn Header="差值百分比(%)" Binding="{Binding DifferencePercentage, StringFormat=F2}" Width="120"/>
          <DataGridTextColumn Header="平衡状态" Width="100">
            <DataGridTextColumn.Binding>
              <Binding Path="BalanceStatus">
                <Binding.Converter>
                  <vm:BalanceStatusToTextConverter/>
                </Binding.Converter>
              </Binding>
            </DataGridTextColumn.Binding>
          </DataGridTextColumn>
        </DataGrid.Columns>
      </DataGrid>

      <!-- 说明文字 -->
      <TextBlock Grid.Row="5" 
                 Text="说明：绿色表示平衡，红色表示不平衡，灰色表示未知状态。双击可查看详细信息。" 
                 FontSize="12" 
                 Foreground="Gray" 
                 Margin="0,10,0,0"/>
    </Grid>
  </ScrollViewer>

</UserControl> 