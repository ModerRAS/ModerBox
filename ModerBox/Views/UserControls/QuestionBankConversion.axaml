<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:vm="using:ModerBox.ViewModels"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:ui="using:FluentAvalonia.UI.Controls"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="600"
             x:DataType="vm:QuestionBankConversionViewModel"
             x:Class="ModerBox.Views.UserControls.QuestionBankConversion">
    <UserControl.Resources>
        <ResourceDictionary>
            <SolidColorBrush x:Key="QbPanelBackgroundBrush" Color="#F5F5F5" />
            <SolidColorBrush x:Key="QbStatusBackgroundBrush" Color="#E3F2FD" />
            <SolidColorBrush x:Key="QbStatusBorderBrush" Color="#2196F3" />
            <ResourceDictionary.ThemeDictionaries>
                <ResourceDictionary x:Key="Dark">
                    <SolidColorBrush x:Key="QbPanelBackgroundBrush" Color="#2A2F36" />
                    <SolidColorBrush x:Key="QbStatusBackgroundBrush" Color="#1B3354" />
                    <SolidColorBrush x:Key="QbStatusBorderBrush" Color="#64B5F6" />
                </ResourceDictionary>
            </ResourceDictionary.ThemeDictionaries>
        </ResourceDictionary>
    </UserControl.Resources>
    <Design.DataContext>
        <vm:QuestionBankConversionViewModel/>
    </Design.DataContext>

    <ScrollViewer>
        <StackPanel Margin="20" Spacing="15">
            <!-- 标题 -->
            <TextBlock Text="题库转换工具" FontSize="24" FontWeight="Bold" Margin="0 0 0 10"/>
            
            <!-- 说明 -->
            <ui:InfoBar Title="功能说明"
                        Severity="Informational"
                        IsClosable="False"
                        IsOpen="True"
                        Margin="0 0 0 10"
                        Padding="15">
                <StackPanel Spacing="5">
                    <TextBlock Text="• 支持从多种格式的题库文件读取题目" TextWrapping="Wrap"/>
                    <TextBlock Text="• 支持导出为考试宝、磨题帮格式" TextWrapping="Wrap"/>
                    <TextBlock Text="• 支持单选题、多选题、判断题" TextWrapping="Wrap"/>
                </StackPanel>
            </ui:InfoBar>

            <!-- 源文件选择 -->
            <StackPanel Spacing="8">
                <TextBlock Text="源文件" FontWeight="SemiBold"/>
                <Grid ColumnDefinitions="*,Auto">
                    <TextBox Grid.Column="0" 
                             Margin="0 0 10 0" 
                             Watermark="选择题库源文件" 
                             Text="{Binding SourceFile}"
                             IsReadOnly="True"/>
                    <Button Grid.Column="1" 
                            Content="浏览..." 
                            Command="{Binding SelectSourceFile}" 
                            Width="100"/>
                </Grid>
            </StackPanel>

            <!-- 源格式选择 -->
            <StackPanel Spacing="8">
                <TextBlock Text="源格式" FontWeight="SemiBold"/>
                <ComboBox ItemsSource="{Binding SourceFormatOptions}"
                          SelectedItem="{Binding SelectedSourceFormat}"
                          DisplayMemberBinding="{Binding DisplayName}"
                          HorizontalAlignment="Stretch"/>
            </StackPanel>

            <!-- 目标格式选择 -->
            <StackPanel Spacing="8">
                <TextBlock Text="目标格式" FontWeight="SemiBold"/>
                <ComboBox ItemsSource="{Binding TargetFormatOptions}"
                          SelectedItem="{Binding SelectedTargetFormat}"
                          DisplayMemberBinding="{Binding DisplayName}"
                          HorizontalAlignment="Stretch"/>
            </StackPanel>

            <!-- 目标文件选择 -->
            <StackPanel Spacing="8">
                <TextBlock Text="目标文件" FontWeight="SemiBold"/>
                <Grid ColumnDefinitions="*,Auto">
                    <TextBox Grid.Column="0" 
                             Margin="0 0 10 0" 
                             Watermark="选择保存位置" 
                             Text="{Binding TargetFile}"
                             IsReadOnly="True"/>
                    <Button Grid.Column="1" 
                            Content="浏览..." 
                            Command="{Binding SelectTargetFile}" 
                            Width="100"/>
                </Grid>
            </StackPanel>

            <!-- 转换按钮 -->
        <Button Content="开始转换"
            Command="{Binding RunConversion}"
            HorizontalAlignment="Stretch"
            Height="40"
            FontSize="16"
            Margin="0 10 0 0"/>

        <ProgressBar IsIndeterminate="True" IsVisible="{Binding IsBusy}" Height="4"/>

            <!-- 状态显示 -->
            <ui:InfoBar Title="状态"
                        IsOpen="True"
                        IsClosable="False"
                        Severity="{Binding StatusSeverity}"
                        Message="{Binding Status}"/>

            <!-- 大模型解析配置 -->
            <ui:InfoBar Title="大模型解析配置"
                        Severity="Informational"
                        IsClosable="False"
                        IsOpen="True"
                        Padding="15">
                <StackPanel Spacing="12">
                    <!-- 启用开关 -->
                    <StackPanel Orientation="Horizontal" Spacing="10">
                        <ToggleSwitch IsChecked="{Binding LlmEnabled}"
                                      OnContent="已启用"
                                      OffContent="已禁用"/>
                        <TextBlock Text="启用大模型自动生成题目解析"
                                   VerticalAlignment="Center"
                                   Opacity="0.8"/>
                    </StackPanel>

                    <!-- 配置面板（仅在启用时显示） -->
                    <StackPanel Spacing="10" IsVisible="{Binding LlmEnabled}">
                        <Grid ColumnDefinitions="100,*" RowDefinitions="Auto,Auto,Auto,Auto" RowSpacing="8">
                            <!-- API URL -->
                            <TextBlock Grid.Row="0" Grid.Column="0" 
                                       Text="API 地址" 
                                       VerticalAlignment="Center"/>
                            <TextBox Grid.Row="0" Grid.Column="1"
                                     Text="{Binding LlmApiUrl}"
                                     Watermark="https://api.openai.com/v1/chat/completions"/>

                            <!-- API Key -->
                            <TextBlock Grid.Row="1" Grid.Column="0" 
                                       Text="API Key" 
                                       VerticalAlignment="Center"/>
                            <TextBox Grid.Row="1" Grid.Column="1"
                                     Text="{Binding LlmApiKey}"
                                     PasswordChar="•"
                                     Watermark="sk-..."/>

                            <!-- 模型名称 -->
                            <TextBlock Grid.Row="2" Grid.Column="0" 
                                       Text="模型名称" 
                                       VerticalAlignment="Center"/>
                            <TextBox Grid.Row="2" Grid.Column="1"
                                     Text="{Binding LlmModelName}"
                                     Watermark="gpt-4o-mini"/>

                            <!-- 并发数 -->
                            <TextBlock Grid.Row="3" Grid.Column="0" 
                                       Text="并发数" 
                                       VerticalAlignment="Center"/>
                            <NumericUpDown Grid.Row="3" Grid.Column="1"
                                           Value="{Binding LlmMaxConcurrencyInput}"
                                           Minimum="1"
                                           Width="120"
                                           HorizontalAlignment="Left"/>
                        </Grid>

                        <!-- 保存按钮 -->
                        <Button Content="保存配置"
                                Command="{Binding SaveLlmConfigCommand}"
                                HorizontalAlignment="Left"/>

                        <!-- 进度显示 -->
                        <StackPanel Orientation="Horizontal" Spacing="10" IsVisible="{Binding LlmProgress, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                            <TextBlock Text="解析进度：" Opacity="0.8"/>
                            <TextBlock Text="{Binding LlmProgress}" FontWeight="SemiBold"/>
                            <Button Content="取消" 
                                    Command="{Binding CancelLlmCommand}"
                                    IsVisible="{Binding IsBusy}"
                                    Padding="8,2"/>
                        </StackPanel>

                        <!-- 缓存信息 -->
                        <StackPanel Orientation="Horizontal" Spacing="10">
                            <TextBlock Text="{Binding CacheStats}" Opacity="0.7"/>
                            <Button Content="清除缓存" 
                                    Command="{Binding ClearCacheCommand}"
                                    Padding="8,2"/>
                        </StackPanel>

                        <!-- 说明 -->
                        <TextBlock Text="提示：配置会自动保存到 AppData 目录，解析结果会缓存以支持断点续传。"
                                   Opacity="0.6"
                                   FontSize="12"
                                   TextWrapping="Wrap"/>
                    </StackPanel>
                </StackPanel>
            </ui:InfoBar>

            <!-- 支持的格式说明（自动从 QuestionBank 项目的枚举特性中读取） -->
            <ui:InfoBar Title="支持的格式说明"
                        Severity="Informational"
                        IsClosable="False"
                        IsOpen="True"
                        Padding="15">
                <StackPanel Spacing="10">
                    <StackPanel Spacing="5">
                        <TextBlock Text="源格式：" FontWeight="Bold"/>
                        <ItemsControl ItemsSource="{Binding SourceFormatDescriptions}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock TextWrapping="Wrap">
                                        <Run Text="• "/>
                                        <Run Text="{Binding DisplayName}"/>
                                        <Run Text="："/>
                                        <Run Text="{Binding Detail}"/>
                                    </TextBlock>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>

                    <StackPanel Spacing="5">
                        <TextBlock Text="目标格式：" FontWeight="Bold"/>
                        <ItemsControl ItemsSource="{Binding TargetFormatDescriptions}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock TextWrapping="Wrap">
                                        <Run Text="• "/>
                                        <Run Text="{Binding DisplayName}"/>
                                        <Run Text="："/>
                                        <Run Text="{Binding Detail}"/>
                                    </TextBlock>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </StackPanel>
            </ui:InfoBar>
        </StackPanel>
    </ScrollViewer>
</UserControl>
